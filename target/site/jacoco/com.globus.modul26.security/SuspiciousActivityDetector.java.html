<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SuspiciousActivityDetector.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">modul26</a> &gt; <a href="index.source.html" class="el_package">com.globus.modul26.security</a> &gt; <span class="el_source">SuspiciousActivityDetector.java</span></div><h1>SuspiciousActivityDetector.java</h1><pre class="source lang-java linenums">package com.globus.modul26.security;

import com.globus.modul26.model.SecurityLog;
import com.globus.modul26.repository.SecurityLogRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.util.*;

@Component
<span class="fc" id="L12">public class SuspiciousActivityDetector {</span>

    @Autowired
    private SecurityLogRepository logRepository;

<span class="fc" id="L17">    private static final Set&lt;String&gt; BLACKLISTED_COUNTRIES = Set.of(&quot;UKR&quot;, &quot;USA&quot;, &quot;POL&quot;);</span>

    /**
     * Вытаскиваем geoLocation как &quot;country,city&quot; из metadata.
     */
    private static String extractGeoLocation(SecurityLog log) {
<span class="nc" id="L23">        Map&lt;String, Object&gt; md = log.getMetadata();</span>
<span class="nc bnc" id="L24" title="All 4 branches missed.">        String country = md != null &amp;&amp; md.get(&quot;country&quot;) != null ? md.get(&quot;country&quot;).toString() : &quot;&quot;;</span>
<span class="nc bnc" id="L25" title="All 4 branches missed.">        String city = md != null &amp;&amp; md.get(&quot;city&quot;) != null ? md.get(&quot;city&quot;).toString() : &quot;&quot;;</span>
<span class="nc" id="L26">        return country + &quot;,&quot; + city;</span>
    }

    public void analyze(SecurityLog log) {
<span class="nc" id="L30">        Long userId = log.getUserId();</span>

        //  IP
<span class="nc bnc" id="L33" title="All 2 branches missed.">        if (isNewIp(userId, log.getIpAddress())) {</span>
<span class="nc" id="L34">            System.out.println(&quot;Вход с нового IP: &quot; + log.getIpAddress());</span>
        }

        //  GEO
<span class="nc" id="L38">        String geoLocation = extractGeoLocation(log);</span>

<span class="nc bnc" id="L40" title="All 2 branches missed.">        if (isNewGeo(userId, geoLocation)) {</span>
<span class="nc" id="L41">            System.out.println(&quot;Вход с новой геолокации: &quot; + geoLocation);</span>
        }

        //  Device
<span class="nc bnc" id="L45" title="All 2 branches missed.">        if (isNewDevice(userId, log.getDeviceInfo())) {</span>
<span class="nc" id="L46">            System.out.println(&quot;Вход с нового устройства: &quot; + log.getDeviceInfo());</span>
        }


<span class="nc bnc" id="L50" title="All 2 branches missed.">        if (hasTooManyFailedAttempts(userId)) {</span>
<span class="nc" id="L51">            System.out.println(&quot;Частые неудачные попытки входа!&quot;);</span>
        }


<span class="nc bnc" id="L55" title="All 2 branches missed.">        if (hasTooManyPasswordChanges(userId)) {</span>
<span class="nc" id="L56">            System.out.println(&quot;Множественные смены пароля за короткое время!&quot;);</span>
        }


<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (isLoginWithoutBiometryWhereWasBiometryBefore(userId, log)) {</span>
<span class="nc" id="L61">            System.out.println(&quot;Попытка входа с устройства без биометрии, где раньше использовалась биометрия!&quot;);</span>
        }


<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (isBlacklistedCountry(geoLocation)) {</span>
<span class="nc" id="L66">            System.out.println(&quot;Активность из страны из чёрного списка!&quot;);</span>
        }


<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (isUserAgentMismatch(userId, log.getDeviceInfo())) {</span>
<span class="nc" id="L71">            System.out.println(&quot;Несоответствие User-Agent между сессиями!&quot;);</span>
        }
<span class="nc" id="L73">    }</span>

    private boolean isNewIp(Long userId, String currentIp) {
<span class="nc" id="L76">        List&lt;SecurityLog&gt; logs = logRepository.findByUserId(userId);</span>
<span class="nc" id="L77">        return logs.stream().noneMatch(log -&gt; currentIp.equals(log.getIpAddress()));</span>
    }

    private boolean isNewGeo(Long userId, String currentGeo) {
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (currentGeo == null) return false;</span>
<span class="nc" id="L82">        List&lt;SecurityLog&gt; logs = logRepository.findByUserId(userId);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        for (SecurityLog log : logs) {</span>
<span class="nc" id="L84">            String logGeo = extractGeoLocation(log);</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            if (currentGeo.equals(logGeo)) {</span>
<span class="nc" id="L86">                return false;</span>
            }
<span class="nc" id="L88">        }</span>
<span class="nc" id="L89">        return true;</span>
    }

    private boolean isNewDevice(Long userId, String currentDevice) {
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (currentDevice == null) return false;</span>
<span class="nc" id="L94">        List&lt;SecurityLog&gt; logs = logRepository.findByUserId(userId);</span>
<span class="nc" id="L95">        return logs.stream().noneMatch(log -&gt; currentDevice.equals(log.getDeviceInfo()));</span>
    }

    private boolean hasTooManyFailedAttempts(Long userId) {
<span class="nc" id="L99">        LocalDateTime fiveMinsAgo = LocalDateTime.now().minusMinutes(5);</span>
<span class="nc" id="L100">        List&lt;SecurityLog&gt; logs =</span>
<span class="nc" id="L101">                logRepository.findByUserIdAndIsSuspiciousAndCreatedAtAfter(userId, false, fiveMinsAgo);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">        return logs.size() &gt; 3;</span>
    }

    private boolean hasTooManyPasswordChanges(Long userId) {
<span class="nc" id="L106">        LocalDateTime dayAgo = LocalDateTime.now().minusDays(1);</span>
<span class="nc" id="L107">        List&lt;SecurityLog&gt; logs =</span>
<span class="nc" id="L108">                logRepository.findByUserIdAndEventTypeAndCreatedAtAfter(userId, &quot;PASSWORD_CHANGE&quot;, dayAgo);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">        return logs.size() &gt; 2;</span>
    }

    private boolean isLoginWithoutBiometryWhereWasBiometryBefore(Long userId, SecurityLog log) {
<span class="nc bnc" id="L113" title="All 4 branches missed.">        if (!&quot;LOGIN&quot;.equals(log.getEventType()) || Boolean.TRUE.equals(log.getBiometryUsed())) return false;</span>
<span class="nc" id="L114">        List&lt;SecurityLog&gt; logs = logRepository.findByUserIdAndBiometryUsed(userId, true);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        return !logs.isEmpty();</span>
    }

    private boolean isBlacklistedCountry(String geoLocation) {
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (geoLocation == null) return false;</span>
<span class="nc" id="L120">        String country = geoLocation.split(&quot;,&quot;)[0].trim();</span>
<span class="nc" id="L121">        return BLACKLISTED_COUNTRIES.contains(country);</span>
    }

    private boolean isUserAgentMismatch(Long userId, String currentDeviceInfo) {
<span class="nc" id="L125">        List&lt;SecurityLog&gt; logs = logRepository.findByUserId(userId);</span>
<span class="nc" id="L126">        Set&lt;String&gt; agents = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">        for (SecurityLog log : logs) {</span>
<span class="nc" id="L128">            agents.add(log.getDeviceInfo());</span>
<span class="nc" id="L129">        }</span>
<span class="nc bnc" id="L130" title="All 4 branches missed.">        return agents.size() &gt; 1 &amp;&amp; !agents.contains(currentDeviceInfo);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>